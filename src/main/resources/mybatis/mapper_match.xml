<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="io.github.wizwix.letsfutsal.mapper.MatchMapper">
  <!-- 개인 경기 참가자 수 조회 -->
  <select id="countIndividualPlayers" parameterType="long" resultType="int">
    select count(*)
    from letsfutsal.match_individual_players
    where match_id = #{matchId}
  </select>
  <!-- 팀 경기 참가 팀 수 조회 -->
  <select id="countTeamParticipants" parameterType="long" resultType="int">
    select count(*)
    from letsfutsal.match_team_participants
    where match_id = #{matchId}
  </select>
  <insert id="insertIndividualParticipant">
    insert into letsfutsal.match_individual_players (match_id, user_id)
    values (#{matchId}, #{userId})
  </insert>
  <insert id="insertMatch" parameterType="io.github.wizwix.letsfutsal.dto.MatchDTO" useGeneratedKeys="true" keyProperty="match.matchId">
    insert into letsfutsal.game_match (stadium_id, renter_entity_id, match_type, match_date, start_hour, end_hour, gender, min_grade, max_grade, status)
    values (#{match.stadiumId}, #{match.renterEntityId}, #{match.matchType}, #{match.matchDate}, #{match.startHour}, #{match.endHour}, #{match.gender}, #{match.minGrade}, #{match.maxGrade}, #{match.status})
  </insert>
  <insert id="insertTeamParticipant">
    insert into letsfutsal.match_team_participants (match_id, team_id)
    values (#{matchId}, #{teamId})
  </insert>
  <update id="modifyMatchStatus">
    update letsfutsal.game_match
    set status = status + #{increment}
    where match_id = #{matchId}
  </update>
  <select id="selectMatchById" parameterType="long" resultType="io.github.wizwix.letsfutsal.dto.MatchDTO">
    select *
    from letsfutsal.game_match
    where match_id = #{matchId}
  </select>
  <!-- 경기 목록 조회 (필터링 포함) -->
  <select id="selectMatchList" resultType="io.github.wizwix.letsfutsal.dto.MatchDTO">
    select
      m.*,
      s.name as stadiumName,
      s.region
    from letsfutsal.game_match m
    join letsfutsal.stadium s on m.stadium_id = s.stadium_id
    where 1=1
      <if test="matchType != null">
        and m.match_type = #{matchType}
      </if>
      <if test="region != null">
        and s.region like concat('%', #{region}, '%')
      </if>
      <if test="startHour != null">
        and m.match_date >= curdate() and m.start_hour &gt;= #{startHour}
      </if>
      <if test="endHour != null">
        and m.match_date >= curdate() and m.end_hour &lt;= #{endHour}
      </if>
      <if test="gender != null">
        and m.gender = #{gender}
      </if>
      <if test="minGrade != null">
        and m.min_grade >= #{minGrade}
      </if>
      <if test="maxGrade != null">
        and m.min_grade &lt;= #{maxGrade}
      </if>
      <if test="status != null">
        and m.status >= #{status}
      </if>
    order by m.match_date
  </select>
  <select id="selectMatchesByFilters" resultType="io.github.wizwix.letsfutsal.dto.MatchDTO">
    select m.*, s.name as stadium_name, s.region
    from letsfutsal.game_match m
           join letsfutsal.stadium s on m.stadium_id = s.stadium_id
    <where>
      <if test="date != null">
        and m.match_date = #{date}
      </if>
      <if test="region != null and region != '전체'">
        and s.region = #{region}
      </if>
      <if test="type != null and type != '전체'">
        and m.match_type = #{type}
      </if>
    </where>
    order by m.start_hour
  </select>
  <select id="selectMatchesByRegionAndType" resultType="io.github.wizwix.letsfutsal.dto.MatchDTO">
    select m.*
    from letsfutsal.game_match m
           join letsfutsal.stadium s on m.stadium_id = s.stadium_id
    where s.region = #{region}
      and m.match_type = #{type}
  </select>
  <select id="selectUpcomingMatches" resultType="io.github.wizwix.letsfutsal.dto.MatchDTO">
    <![CDATA[
    select *
    from letsfutsal.game_match
    where timestamp(match_date, start_hour) >= now()
      and match_date < date_add(curdate(), interval 8 day)
    order by status desc, match_date
    ]]>
  </select>
  <update id="updateMatchStatus">
    update letsfutsal.game_match
    set status = #{status}
    where match_id = #{matchId}
  </update>
</mapper>
