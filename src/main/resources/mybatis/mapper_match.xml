<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="io.github.wizwix.letsfutsal.mapper.MatchMapper">
  <!-- 개인 경기 참가자 수 조회 -->
  <select id="countIndividualPlayers" parameterType="long" resultType="int">
    select count(*)
    from letsfutsal.match_individual_players
    where match_id = #{matchId}
  </select>
  <!-- 팀 경기 참가 팀 수 조회 -->
  <select id="countTeamParticipants" parameterType="long" resultType="int">
    select count(*)
    from letsfutsal.match_team_participants
    where match_id = #{matchId}
  </select>
  <insert id="insertIndividualParticipant">
    insert into letsfutsal.match_individual_players (match_id, user_id)
    values (#{matchId}, #{userId})
  </insert>
  <insert id="insertMatch" parameterType="io.github.wizwix.letsfutsal.dto.MatchDTO" useGeneratedKeys="true" keyProperty="match.matchId">
    insert into letsfutsal.game_match (stadium_id, renter_entity_id, match_type, match_date, start_hour, end_hour, gender, min_grade, max_grade, status)
    values (#{match.stadiumId}, #{match.renterEntityId}, #{match.matchType}, #{match.matchDate}, #{match.startHour}, #{match.endHour}, #{match.gender}, #{match.minGrade}, #{match.maxGrade}, #{match.status})
  </insert>
  <insert id="insertTeamParticipant">
    insert into letsfutsal.match_team_participants (match_id, team_id)
    values (#{matchId}, #{teamId})
  </insert>
  <update id="modifyMatchStatus">
    update letsfutsal.game_match
    set status = status + #{increment}
    where match_id = #{matchId}
  </update>
  <select id="selectMatchById" parameterType="long" resultType="io.github.wizwix.letsfutsal.dto.MatchDTO">
    select *
    from letsfutsal.game_match
    where match_id = #{matchId}
  </select>
  <!-- 경기 목록 조회 (필터링 포함) -->
  <select id="selectMatchList" resultType="io.github.wizwix.letsfutsal.dto.MatchDTO">
    select
      m.match_id as matchId,
      s.location as stadiumName,
      m.match_type as matchType,
      m.match_datetime as matchDateTime,
      m.gender,
      concat(m.min_grade, '~', m.max_grade, '급') as category1,
      case
        when m.min_grade = 0 and m.max_grade = 1 then '초급'
        when m.min_grade = 1 and m.max_grade = 2 then '중급'
        when m.min_grade = 2 and m.max_grade = 3 then '고급'
        else '전체'
      end as category2,
      s.region as category3,
      case
        when m.match_type = 'INDIVIDUAL' then
          (select count(*) from letsfutsal.match_individual_players where match_id = m.match_id) &lt; 10
        when m.match_type = 'TEAM' then
          (select count(*) from letsfutsal.match_team_participants where match_id = m.match_id) &lt; 2
        else 0
      end as available
    from letsfutsal.game_match m
    join letsfutsal.stadium s on m.stadium_id = s.stadium_id
    where 1=1
      <if test="matchType != null and matchType != ''">
        AND m.match_type = #{matchType}
      </if>
      <if test="stadiumName != null and stadiumName != ''">
        AND (s.location LIKE CONCAT('%', #{stadiumName}, '%') OR s.region LIKE CONCAT('%', #{stadiumName}, '%'))
      </if>
      <if test="startDateTime != null">
        AND m.match_datetime &gt;= #{startDateTime}
      </if>
      <if test="endDateTime != null">
        AND m.match_datetime &lt;= #{endDateTime}
      </if>
      <if test="gender != null and gender != ''">
        AND m.gender = #{gender}
      </if>
      <if test="minGrade != null">
        AND m.min_grade &lt;= #{minGrade} AND m.max_grade &gt;= #{minGrade}
      </if>
      <if test="maxGrade != null">
        AND m.min_grade &lt;= #{maxGrade} AND m.max_grade &gt;= #{maxGrade}
      </if>
      <if test="available != null">
        AND (
          <if test="available == true">
            (m.match_type = 'INDIVIDUAL' AND (SELECT COUNT(*) FROM letsfutsal.match_individual_players WHERE match_id = m.match_id) &lt; 10)
            OR
            (m.match_type = 'TEAM' AND (SELECT COUNT(*) FROM letsfutsal.match_team_participants WHERE match_id = m.match_id) &lt; 2)
          </if>
          <if test="available == false">
            (m.match_type = 'INDIVIDUAL' AND (SELECT COUNT(*) FROM letsfutsal.match_individual_players WHERE match_id = m.match_id) &gt;= 10)
            OR
            (m.match_type = 'TEAM' AND (SELECT COUNT(*) FROM letsfutsal.match_team_participants WHERE match_id = m.match_id) &gt;= 2)
          </if>
        )
      </if>
    ORDER BY m.match_datetime ASC
  </select>
  <select id="selectMatchesByFilters" resultType="io.github.wizwix.letsfutsal.dto.MatchDTO">
    select m.*, s.name as stadium_name, s.region
    from letsfutsal.game_match m
           join letsfutsal.stadium s on m.stadium_id = s.stadium_id
    <where>
      <if test="date != null">
        and m.match_date = #{date}
      </if>
      <if test="region != null and region != '전체'">
        and s.region = #{region}
      </if>
      <if test="type != null and type != '전체'">
        and m.match_type = #{type}
      </if>
    </where>
    order by m.start_hour
  </select>
  <select id="selectMatchesByRegionAndType" resultType="io.github.wizwix.letsfutsal.dto.MatchDTO">
    select m.*
    from letsfutsal.game_match m
           join letsfutsal.stadium s on m.stadium_id = s.stadium_id
    where s.region = #{region}
      and m.match_type = #{type}
  </select>
  <select id="selectUpcomingMatches" resultType="io.github.wizwix.letsfutsal.dto.MatchDTO">
    <![CDATA[
    select *
    from letsfutsal.game_match
    where timestamp(match_date, start_hour) >= now()
      and match_date < date_add(curdate(), interval 8 day)
    order by status, match_date
    ]]>
  </select>
  <update id="updateMatchStatus">
    update letsfutsal.game_match
    set status = #{status}
    where match_id = #{matchId}
  </update>
</mapper>
